<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Do HRV right - Know Thyself</title><meta name="Description" content="Hugo theme - LoveIt"><meta property="og:title" content="Do HRV right" />
<meta property="og:description" content="ECG Time Series Variability Analysis Engineering and Medicine by Cornforth, David Jelinek, Herbert Franz Khandoker, Ahsan Habib, 2018 Considerations in the assessment of heart rate variability in biobehavioral research Simple HRV analysis pipeline and documentation from Neurokit2 Water intake increases HRV in a dose dependent manner Water consumption as a source of error in the measurement of heart rate variability Caffeine intake, some medications, alcohol consumption, time of day, exercise, food inatake, water intake and bladder filling influence HRV" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rahulvenugopal.github.io/haveyoumetrahul/blog/heart-rate-variablity/template/" /><meta property="og:image" content="https://rahulvenugopal.github.io/haveyoumetrahul/47"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-01-05T21:57:40+08:00" />
<meta property="article:modified_time" content="2024-10-12T11:29:08+05:30" /><meta property="og:site_name" content="LoveIt" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rahulvenugopal.github.io/haveyoumetrahul/47"/>

<meta name="twitter:title" content="Do HRV right"/>
<meta name="twitter:description" content="ECG Time Series Variability Analysis Engineering and Medicine by Cornforth, David Jelinek, Herbert Franz Khandoker, Ahsan Habib, 2018 Considerations in the assessment of heart rate variability in biobehavioral research Simple HRV analysis pipeline and documentation from Neurokit2 Water intake increases HRV in a dose dependent manner Water consumption as a source of error in the measurement of heart rate variability Caffeine intake, some medications, alcohol consumption, time of day, exercise, food inatake, water intake and bladder filling influence HRV"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://rahulvenugopal.github.io/haveyoumetrahul/blog/heart-rate-variablity/template/" /><link rel="prev" href="https://rahulvenugopal.github.io/haveyoumetrahul/blog/data-viz/data-stories/" /><link rel="next" href="https://rahulvenugopal.github.io/haveyoumetrahul/blog/data-viz/portfolio/" /><link rel="stylesheet" href="/haveyoumetrahul/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Do HRV right",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/rahulvenugopal.github.io\/haveyoumetrahul\/blog\/heart-rate-variablity\/template\/"
        },"image": ["https:\/\/rahulvenugopal.github.io\/images\/Apple-Devices-Preview.png"],"genre": "blog","wordcount":  586 ,
        "url": "https:\/\/rahulvenugopal.github.io\/haveyoumetrahul\/blog\/heart-rate-variablity\/template\/","datePublished": "2023-01-05T21:57:40+08:00","dateModified": "2024-10-12T11:29:08+05:30","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/rahulvenugopal.github.io\/haveyoumetrahul\/images\/avatar.png",
                    "width":  811 ,
                    "height":  785 
                }},"author": {
                "@type": "Person",
                "name": "Rahul"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/haveyoumetrahul/" title="Know Thyself">have_you_met_rahul</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/haveyoumetrahul/about"> About me </a><a class="menu-item" href="/haveyoumetrahul/research"> Research </a><a class="menu-item" href="/haveyoumetrahul/blog"> Blog </a><a class="menu-item" href="/haveyoumetrahul/faq"> FAQ </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/haveyoumetrahul/" title="Know Thyself">have_you_met_rahul</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/haveyoumetrahul/about" title="">About me</a><a class="menu-item" href="/haveyoumetrahul/research" title="">Research</a><a class="menu-item" href="/haveyoumetrahul/blog" title="">Blog</a><a class="menu-item" href="/haveyoumetrahul/faq" title="">FAQ</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">Do HRV right</h1><div class="content" id="content"><ol>
<li><a href="https://www.routledge.com/ECG-Time-Series-Variability-Analysis-Engineering-and-Medicine/Jelinek-Cornforth-Khandoker/p/book/9780367870157#" target="_blank" rel="noopener noreffer ">ECG Time Series Variability Analysis Engineering and Medicine</a> by Cornforth, David Jelinek, Herbert Franz Khandoker, Ahsan Habib, 2018</li>
<li><a href="https://pubmed.ncbi.nlm.nih.gov/25101047/" target="_blank" rel="noopener noreffer ">Considerations in the assessment of heart rate variability in biobehavioral research</a></li>
<li><a href="https://github.com/rahulvenugopal/HRV_adventures" target="_blank" rel="noopener noreffer ">Simple HRV analysis pipeline and documentation from Neurokit2</a></li>
</ol>
<blockquote>
<p>Water intake increases HRV in a dose dependent manner <a href="https://osf.io/83exy/" target="_blank" rel="noopener noreffer ">Water consumption as a source of error in the measurement of heart rate variability</a>
Caffeine intake, some medications, alcohol consumption, time of day, exercise, food inatake, water intake and bladder filling influence HRV</p>
</blockquote>
<ol start="4">
<li><a href="https://pubmed.ncbi.nlm.nih.gov/27914167/" target="_blank" rel="noopener noreffer ">Statistical considerations for reporting and planning heart rate variability case-control studies</a></li>
<li><a href="https://www.nature.com/articles/tp201673" target="_blank" rel="noopener noreffer ">Guidelines for Reporting Articles on Psychiatry and Heart rate variability (GRAPH): recommendations to advance research communication</a></li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">So, I collected ECG data using lead I and Neurokit2 failed to pickup the R peaks correctly and ended up picking up S! Deep diving to know why</div>
        </div>
    </div>
<p>Let us look at what happens to the ECG data once it enters the pipeline.</p>
<h4 id="stop-1-ecg_clean">Stop 1: <code>ecg_clean</code></h4>
<ul>
<li>Default method to clean ECG is <code>neurokit</code></li>
<li>Check for any <code>nan</code> in the data and returns missing datapoints</li>
<li>If there are gaps, they are filled with last available value (forward filling method)</li>
<li>There is a high pass filter set at <code>0.5</code> Hz butterworth filter (order = 5), followed by a powerline filtering (By default, <code>powerline = 50</code>)</li>
</ul>
<h4 id="stop-2-ecg_peaks">Stop 2: <code>ecg_peaks</code></h4>
<ul>
<li>Default method to identify peaks is <code>neurokit</code></li>
<li>QRS complexes are detected based on the steepness of the absolute gradient of the ECG signal. Subsequently, R-peaks are detected as local maxima in the QRS complexes. Refer this <a href="https://joss.theoj.org/papers/10.21105/joss.02621" target="_blank" rel="noopener noreffer ">paper</a> for details</li>
</ul>
<h4 id="in-short">In short</h4>
<ol>
<li>Compute the ECG gradient to detect rapid changes in slope (rate of change)
<figure><img src="1%20Raw%20data.png"/>
</figure>

<figure><img src="2%20Gradient.png"/>
</figure>

Take absolute values of gradient so that we don&rsquo;t miss out negative going waves
<figure><img src="3%20Abs%20Gradient.png"/>
</figure>
</li>
<li>Smooth the absolute gradient to reduce noise using one tenth of a second long <code>boxcar</code> kernel
<figure><img src="4%20Smooth%20grad.png"/>
</figure>

One more level of smoothing using 75 percent of a second long kernel. This would be ultra smooth
<figure><img src="5%20avggrad.png"/>
</figure>

3.Set a dynamic threshold to identify QRS complexes using the double smooth signal. The threshold is set at 1.5 times the smooth curve optimised for finding peaks
<figure><img src="6%20DynamicThreshold.png"/>
</figure>
</li>
<li>Detect QRS start and end points based on threshold crossing
<figure><img src="8%20Start%20and%20End%20of%20QRS%20Detection.png"/>
</figure>
</li>
<li>Filter out short QRS complexes that are likely noise
The values are set at one third of a second</li>
<li>Find the most prominent peak within each QRS complex. <strong>This happens via the</strong> <code>locmax[np.argmax(props[&quot;prominences&quot;])]</code>. <code>locmax</code> <strong>sees only peaks and not troughs</strong>
<figure><img src="9%20QRS%20Complex.png"/>
</figure>
</li>
</ol>
<blockquote>
<p>This is really critical for R peak detection. If our ECG waveform is flipped (R peaks pointing down), the algorithm would pick the S peak (falling end of R) instead of the peak! See the final comparisons</p>
</blockquote>
<ol start="7">
<li>Apply a refractory period to prevent false detections. Once a peak is detected for identified <code>QRS</code> complex, it compares its proximity to previously identified peak of previous <code>QRS</code> complex. If it is within one third of a second, the current peak is dropped. More like a refractory period idea implemeneted</li>
<li>See the identified peaks
<figure><img src="10%20Overlay%20identified%20R%20peak.png"/>
</figure>
</li>
</ol>
<h3 id="see-what-happens-when-we-flip-the-ecg-waveform">See what happens when we flip the ECG waveform</h3>
<p>R peaks pointing up
<figure><img src="Positive.png"/>
</figure>

R peaks pointing down
<figure><img src="Negative.png"/>
</figure>
</p>
<blockquote>
<p>Observations</p>
</blockquote>
<ul>
<li>The delay in R peak (time from R peak to S peak)</li>
<li>The whole interval gets shifted</li>
<li>The numbers above red dots in panel 1 are the locations of R peak detections</li>
<li>The algorithm becomes an S peak detector</li>
<li>Should we be worries? YES offcourse</li>
<li>The RR interval remains more or less similar in both the scenarios</li>
</ul>
<p><strong>Positive:</strong> 664, 680, 723, 732, 711, 707, 737, 738, 734, 713, 726, 752, 718</p>
<p><strong>Negative:</strong> 664, 680, 722, 732, 712, 706, 737, 738, 734, 713, 726, 752, 719</p>
</div><div id="comments"></div></div></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Maintained by Boodiee</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/haveyoumetrahul/" target="_blank">xxxx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/haveyoumetrahul/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"twemoji":true};</script><script type="text/javascript" src="/haveyoumetrahul/js/theme.min.js"></script></body>
</html>
